<div class="container mx-auto p-4">
  <!-- Title and 'Add New Group' Button -->
  <div class="flex justify-between items-center mb-4">
    <!-- Title -->
    <h2 class="text-3xl font-bold">Project Settings</h2>
    <!-- 'Add New Group' Button -->
    <button
      *ngIf="!isLoading() && !isError()"
      pButton
      label="Add New Group"
      class="p-button-sm"
      (click)="showAddGroupDialog = true"
    ></button>
  </div>

  <!-- Error and Loading Messages -->
  <p *ngIf="isError()" class="text-red-600 mb-4">An error occurred while fetching workflows.</p>
  <p *ngIf="isLoading()" class="text-center mb-4">Loading workflows...</p>

  <!-- Main Content -->
  <div *ngIf="!isLoading() && !isError()">
    <!-- Grouped Workflows Panels -->
    <h3 class="text-2xl font-semibold mb-2">Grouped Workflows</h3>

    <!-- Drag & Drop Hint -->
    <ng-container *ngIf="groupedWorkflowsArray().length > 0">
      <p class="text-sm text-gray-600 mb-4">
        Drag and drop the groups to reorder them.
      </p>
    </ng-container>

    <!-- Grouped Workflows if available -->
    <ng-container *ngIf="groupedWorkflowsArray().length > 0; else noGroupsTemplate">
      <div class="flex items-start gap-4 mb-8">
        <div
          class="flex items-center"
          *ngFor="let group of groupedWorkflowsArray(); index as i"
          pDraggable="groups"
          pDroppable="groups"
          (onDragStart)="dragStart(i)"
          (onDrop)="drop(i)"
        >
          <!-- The panel for this group -->
          <p-panel [header]="group.groupName" class="mr-2 min-w-[250px]">
            <div class="flex flex-col gap-4">
              <div *ngFor="let wf of group.workflows" class="flex items-center space-x-2">
                <i-tabler name="circle-check" class="text-green-500"></i-tabler>
                <span class="font-medium w-36 flex items-center">{{ wf.name }}</span>
              </div>
            </div>
          </p-panel>

          <!-- Horizontal line between panels -->
          <div *ngIf="i < groupedWorkflowsArray().length - 1" class="w-10 h-px bg-gray-300 mt-7"></div>
        </div>
      </div>
    </ng-container>

    <!-- Fallback Template: No Grouping Available -->
    <ng-template #noGroupsTemplate>
      <div class="flex justify-center items-center h-40 mb-8">
        <p-panel header="No Groups Available" class="min-w-[250px]">
          <p class="text-center">No workflows are currently grouped.</p>
          <p class="text-center">Click "Add New Group" to create a new group.</p>
          <p class="text-center">And then assign workflows to the group.</p>
        </p-panel>
      </div>
    </ng-template>

    <!-- Workflow Table -->
    <p-table [value]="workflows()" styleClass="w-full mb-6">
      <ng-template pTemplate="header">
        <tr>
          <th>Workflow ID</th>
          <th>Status</th>
          <th>File Name</th>
          <th>Workflow Name</th>
          <th>Assign Group</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-workflow>
        <tr>
          <td>{{ workflow.id }}</td>
          <td>{{ workflow.state }}</td>
          <td>{{ workflow.fileNameWithExtension }}</td>
          <td>{{ workflow.name }}</td>
          <td>
            <p-dropdown
              [options]="groupDropdownOptions"
              [ngModel]="workflowGroupsMap()[workflow.id] || 'Ungrouped'"
              (onChange)="onChangeGroup(workflow, $event.value)"
              [appendTo]="'body'"
            ></p-dropdown>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Dialog for Adding New Group -->
  <p-dialog
    header="Add New Group"
    [(visible)]="showAddGroupDialog"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    [draggable]="false"
    [style]="{ width: '350px' }"
    (onHide)="resetDialog()"
  >
    <div class="flex flex-col gap-2 p-2">
      <label class="font-semibold" for="groupNameInput">Group Name</label>
      <input
        id="groupNameInput"
        type="text"
        pInputText
        [(ngModel)]="newGroupName"
        class="w-full p-2 border border-gray-300 rounded"
        placeholder="Enter new group name"
      />

      <div class="flex justify-end gap-2 mt-4">
        <button
          pButton
          label="Cancel"
          class="p-button-text"
          (click)="showAddGroupDialog = false"
        ></button>
        <button
          pButton
          label="Add"
          class="p-button-primary"
          (click)="addNewGroup()"
        ></button>
      </div>
    </div>
  </p-dialog>
</div>
