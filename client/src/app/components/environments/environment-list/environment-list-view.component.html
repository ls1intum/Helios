<div class="flex items-center justify-between mb-3">
  <input pInputText id="commit-hash" (input)="onSearch($event)" [value]="searchInput()" type="text" placeholder="Search for installed systems" class="w-1/3" />
  @if (!hideLinkToList()) {
    <a [routerLink]="'/environments'" class="p-button p-2 p-button-secondary self-end">Manage environments</a>
  }
</div>

<p-accordion [multiple]="true">
  @if (!query.isPending() && filteredEnvironments().length === 0) {
    @if (query.isError()) {
      <p>Failed to load environments. Please try again later.</p>
    } @else if (searchInput().length === 0) {
      <p>No environments found. Create a new environment to get started.</p>
    } @else {
      <p>No environments found for the search term, try something else.</p>
    }
  }

  @for (environment of filteredEnvironments(); track environment.id) {
    <p-accordionTab>
      <ng-template pTemplate="header">
        <div class="flex gap-2 items-center w-full">
          <span>{{ environment.name }}</span>

          <app-lock-tag [isLocked]="!!environment.locked"></app-lock-tag>

          @if (environment.locked) {
            @if (environment.deploying) {
              <app-deployment-state-tag [state]="'IN_PROGRESS'" />
            } @else {
              <app-deployment-state-tag [state]="'SUCCESS'" />
            }
          }

          <div class="flex-grow"></div>

          @if (!environment.locked && deployable()) {
            <button (click)="deployEnvironment(environment); $event.stopPropagation()" class="p-button p-button-secondary p-2">
              <i-tabler name="cloud-upload" class="mr-1" />Deploy
            </button>
          }

          @if (environment.locked) {
            @if (environment.serverUrl) {
              <a [href]="getFullUrl(environment.serverUrl)" target="_blank" class="p-button p-button-secondary p-2" (click)="$event.stopPropagation()"
                ><i-tabler name="external-link" class="mr-1" />Open</a
              >
            }
            <button (click)="unlockEnvironment.mutate(environment); $event.stopPropagation()" class="p-button p-button-danger p-2">
              <i-tabler name="lock-open" class="mr-1" />Unlock
            </button>
          }

          @if (editable()) {
            <a icon [routerLink]="'/repo/' + environment.repository?.id + '/environment/' + environment.id + '/edit'" class="p-button p-button-secondary p-2"
              ><i-tabler name="pencil"
            /></a>
          }
        </div>
      </ng-template>
      @if (!environment.locked) {
        <p>This environment is not locked. It is free to be deployed to.</p>
      }
      @if (environment.lockingBranch; as lockingBranch) {
        <a [routerLink]="'/repo/' + environment.repository?.id + '/branch/' + lockingBranch.name" class="p-button p-button-secondary"
          ><i-tabler name="git-branch" class="text-white mr-1" /> Locked by "{{ lockingBranch.name }}"</a
        >
      }

      @if (environment.latestDeployment; as deployment) {
        <app-environment-deployment-info [deployment]="deployment" />
      }

      <div class="flex gap-4 items-center justify-between">
        <div class="flex gap-1 mt-2 items-center">
          <a icon [routerLink]="'/environments/' + environment.id + '/history'" class="p-button p-button-text text-gray-500 p-2"
            ><i-tabler class="mr-1" name="history" />View Deployment History</a
          >
        </div>

        <div class="flex gap-1">
          <p-tag *ngFor="let installedApp of environment.installedApps"> {{ installedApp }}</p-tag>
        </div>
      </div>
    </p-accordionTab>
  }
</p-accordion>
