@if (environmentQuery.isPending() || environmentQuery.isError()) {
  <p-table [value]="[1, 2, 3, 4, 5]">
    <ng-template pTemplate="header">
      <tr>
        <th class="w-[40%]">Name</th>
        <th class="w-[30%]">Status</th>
        <th class="w-[15%]">Deploy</th>
        <th class="w-[15%]">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body">
      <tr>
        <td>
          <p-skeleton class="w-96" />
        </td>
        <td class="w-[0.1%]"><p-skeleton class="w-96" /></td>
        <td class="w-[0.1%]">
          <p-button disabled>Deploy</p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>
} @else {
  <p-table #table [rowHover]="true" [value]="deployableEnvironments() || []" [paginator]="true" [rows]="20">
    <ng-template #header>
      <tr>
        <th class="w-[40%]">Name</th>
        <th class="w-[30%]">Status</th>
        <th class="w-[15%]">Deploy</th>
        <th class="w-[15%]">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-environment>
      <tr>
        <td>
          <span class="flex items-center gap-2">
            {{ environment.name }}
            <span [pTooltip]="'Open Environment'" class="cursor-pointer hover:bg-gray-200 px-2 py-1 rounded flex items-center" (click)="openEnvironment($event, environment)">
              <i-tabler name="external-link" />
            </span>
          </span>
        </td>
        <td>
          @switch (deploymentStatus(environment)) {
            @case ('SUCCESS') {
              <p-tag value="success" class="text-xs" severity="success" />
            }
            @case ('REPLACED') {
              <div class="flex items-center gap-1">
                <p-tag value="replaced" class="text-xs" severity="contrast" />
                now at
                @if (environment.latestDeployment) {
                  @if (environment.latestDeployment.releaseCandidateName) {
                    <p-tag class="text-xs">
                      <i-tabler name="git-branch" class="!size-4" />
                      {{ environment.latestDeployment.releaseCandidateName }}
                    </p-tag>
                  } @else {
                    <p-tag class="text-xs">
                      <i-tabler name="git-branch" class="!size-4" />
                      {{ environment.latestDeployment.ref }}
                    </p-tag>
                  }
                }
              </div>
            }
            @case ('FAILURE') {
              <p-tag value="failed" class="text-xs" severity="danger" />
            }
            @case ('NEVER_DEPLOYED') {
              <div class="flex items-center gap-1">
                @if (environment.latestDeployment) {
                  now at
                  @if (environment.latestDeployment.releaseCandidateName) {
                    <p-tag class="text-xs">
                      <i-tabler name="git-branch" class="!size-4" />
                      {{ environment.latestDeployment.releaseCandidateName }}
                    </p-tag>
                  } @else {
                    <p-tag class="text-xs">
                      <i-tabler name="git-branch" class="!size-4" />
                      {{ environment.latestDeployment.ref }}
                    </p-tag>
                  }
                } @else {
                  no release candidate deployed yet
                }
              </div>
            }
            @default {
              <p-tag value="unknown" class="text-xs" />
              now at {{ environment.latestDeployment.releaseCandidateName }}
            }
          }
        </td>
        <td>
          <p-button (onClick)="deployReleaseCandidate(environment)" [loading]="deployToEnvironment.isPending() && selectedEnvironmentId() === environment.id"> Deploy </p-button>
        </td>
        <td>
          @if (selectedEnvironmentId() === environment.id && deployToEnvironment.isSuccess()) {
            <p-button
              styleClass="p-button-success"
              [loading]="!startQueryingWorkflow() || !workflowRunUrlQuery.data()"
              [disabled]="!workflowRunUrlQuery.data()"
              (onClick)="workflowRunUrlQuery.data() && openWorkflowUrl(workflowRunUrlQuery.data()!)"
            >
              <ng-template pTemplate="content">
                <div class="flex items-center gap-2">
                  <span>Approve</span>
                  <i-tabler name="external-link" class="!size-4" />
                </div>
              </ng-template>
            </p-button>
          }
        </td>
      </tr>
    </ng-template>
    <ng-template #emptymessage>
      <tr>
        <td colspan="4">
          <div class="flex flex-col gap-2 p-20 justify-center items-center">
            <i-tabler name="server-cog" class="!h-20 !w-20 text-red-500" />
            <span class="font-semibold text-xl">There were no environments found.</span>
            <span>Try creating a new environment in GitHub first.</span>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
}
